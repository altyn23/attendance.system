<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Пайдаланушылар</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg-1:#102447; --bg-2:#1f3f7a;
            --panel:rgba(255,255,255,.92); --panel-solid:#ffffff;
            --text:#0f172a; --muted:#64748b; --line:#dbe4f0;
            --brand:#2257c7; --brand-2:#3b82f6; --ok:#16a34a; --danger:#dc2626;
        }
        [data-theme="dark"] {
            --bg-1:#050910; --bg-2:#0f172a;
            --panel:rgba(15,23,42,.92); --panel-solid:#111827;
            --text:#e5e7eb; --muted:#9ca3af; --line:#263244;
            --brand:#3b82f6; --brand-2:#6366f1; --ok:#22c55e; --danger:#ef4444;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Inter", "Manrope", "Segoe UI", sans-serif;
            background: radial-gradient(circle at 10% -20%, #4f46e5 0%, transparent 45%),
                        radial-gradient(circle at 90% 120%, #0ea5a4 0%, transparent 40%),
                        linear-gradient(135deg, var(--bg-1), var(--bg-2));
            color: var(--text);
        }
        .topbar {
            max-width: 1240px; margin: 0 auto; padding: 20px;
            display: flex; justify-content: space-between; align-items: center; gap: 12px;
            color: #f8fafc;
        }
        .title { font-size: 26px; font-weight: 800; }
        .top-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .link-btn {
            border: 1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.14);
            color: #fff; text-decoration: none; padding: 9px 14px; border-radius: 10px; font-weight: 600;
            cursor: pointer;
        }

        .page { max-width: 1240px; margin: 0 auto; padding: 0 20px 26px; }
        .panel {
            background: var(--panel); border-radius: 18px; border: 1px solid rgba(255,255,255,.35);
            box-shadow: 0 14px 34px rgba(2, 6, 23, 0.2); padding: 18px;
        }
        .header-row { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 14px; }
        .header-row h2 { margin: 0; font-size: 28px; }
        .btn {
            border: none; border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer;
            color: #fff;
        }
        .btn-primary { background: linear-gradient(90deg, var(--brand), var(--brand-2)); }
        .btn-ok { background: linear-gradient(90deg, #0ea5a4, var(--ok)); }
        .btn-muted { background: #e2e8f0; color: #0f172a; }

        .stats { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 10px; margin-bottom: 14px; }
        .stat { background: var(--panel-solid); border:1px solid var(--line); border-radius:12px; padding:12px; }
        .stat .num { font-size: 26px; font-weight: 800; }
        .stat .lbl { color: var(--muted); font-size: 13px; margin-top: 4px; }

        .filters { margin-bottom: 10px; }
        .filter-tabs { display:flex; gap:8px; flex-wrap: wrap; margin-bottom: 10px; }
        .filter-btn {
            border: 1px solid var(--line); background: var(--panel-solid); color: var(--text);
            border-radius: 999px; padding: 7px 12px; cursor: pointer; font-size: 13px; font-weight: 700;
        }
        .filter-btn.active { background: linear-gradient(90deg, var(--brand), var(--brand-2)); color: #fff; border-color: transparent; }
        .search { width:100%; border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:var(--panel-solid); color:var(--text); }

        .table-wrap { overflow:auto; background: var(--panel-solid); border:1px solid var(--line); border-radius:12px; }
        table { width:100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 11px; border-bottom: 1px solid var(--line); font-size: 14px; }
        th { background: rgba(148,163,184,.12); text-align:left; }

        .role-badge { padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block; }
        .role-admin { background:#fee2e2; color:#b91c1c; }
        .role-teacher { background:#dbeafe; color:#1d4ed8; }
        .role-student { background:#dcfce7; color:#166534; }

        .actions { display:flex; gap:6px; }
        .action-btn { border:none; border-radius:8px; padding:6px 10px; cursor:pointer; color:#fff; font-weight:700; }
        .edit-btn { background:#f59e0b; }
        .delete-btn { background:var(--danger); }

        .modal { display:none; position:fixed; inset:0; background:rgba(2,6,23,.55); z-index:30; align-items:center; justify-content:center; padding:16px; }
        .modal.show { display:flex; }
        .modal-body {
            width:min(560px,100%); background:var(--panel-solid); color:var(--text); border-radius:16px;
            padding:18px; box-shadow: 0 18px 38px rgba(2,6,23,.3);
        }
        .modal-body h3 { margin:0 0 12px; }
        .field { margin-bottom: 10px; }
        .field label { display:block; font-size:13px; color:var(--muted); margin-bottom:5px; font-weight:600; }
        .field input, .field select { width:100%; border:1px solid var(--line); border-radius:10px; padding:10px; background: var(--panel-solid); color:var(--text); }
        .modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top: 10px; }

        @media (max-width: 700px) {
            .header-row h2 { font-size: 24px; }
        }
    </style>
</head>
<body>
<header class="topbar">
    <div class="title">Пайдаланушылар</div>
    <div class="top-actions">
        <a href="/dashboard" class="link-btn">Басты бет</a>
        <a href="/profile" class="link-btn">Профиль</a>
        <button class="link-btn" onclick="toggleTheme()" id="themeBtn">Тема</button>
        <button class="link-btn" onclick="logout()">Шығу</button>
    </div>
</header>

<main class="page">
    <section class="panel">
        <div class="header-row">
            <h2>Пайдаланушыларды басқару</h2>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="openAddModal()">Жаңа пайдаланушы</button>
                <button class="btn btn-ok" onclick="exportUsers()">Экспорт</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat"><div class="num" id="totalUsers">0</div><div class="lbl">Барлығы</div></div>
            <div class="stat"><div class="num" id="totalStudents">0</div><div class="lbl">Студенттер</div></div>
            <div class="stat"><div class="num" id="totalTeachers">0</div><div class="lbl">Оқытушылар</div></div>
            <div class="stat"><div class="num" id="totalAdmins">0</div><div class="lbl">Әкімшілер</div></div>
        </div>

        <div class="filters">
            <div class="filter-tabs">
                <button class="filter-btn active" onclick="setRoleFilter('ALL', this)">Барлығы</button>
                <button class="filter-btn" onclick="setRoleFilter('STUDENT', this)">Студенттер</button>
                <button class="filter-btn" onclick="setRoleFilter('TEACHER', this)">Оқытушылар</button>
                <button class="filter-btn" onclick="setRoleFilter('ADMIN', this)">Әкімшілер</button>
            </div>
            <input type="text" class="search" id="searchInput" placeholder="Аты, email, топ/кафедра бойынша іздеу" oninput="searchUsers()">
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Аты-жөні</th>
                    <th>Email</th>
                    <th>Телефон</th>
                    <th>Рөлі</th>
                    <th>Топ/Кафедра</th>
                    <th>Тіркелген</th>
                    <th>Әрекеттер</th>
                </tr>
                </thead>
                <tbody id="usersTableBody"></tbody>
            </table>
        </div>
    </section>
</main>

<div class="modal" id="userModal">
    <div class="modal-body">
        <h3 id="modalTitle">Пайдаланушы</h3>
        <form id="userForm">
            <input type="hidden" id="userId">
            <div class="field"><label>Аты</label><input type="text" id="firstName" required></div>
            <div class="field"><label>Тегі</label><input type="text" id="lastName" required></div>
            <div class="field"><label>Email</label><input type="email" id="email" required></div>
            <div class="field"><label>Телефон</label><input type="tel" id="phone"></div>
            <div class="field"><label>Құпиясөз</label><input type="password" id="password"></div>
            <div class="field">
                <label>Рөлі</label>
                <select id="role" required>
                    <option value="STUDENT">Студент</option>
                    <option value="TEACHER">Оқытушы</option>
                    <option value="ADMIN">Әкімші</option>
                </select>
            </div>
            <div class="field"><label>Топ</label><input type="text" id="group" placeholder="ИС-2101"></div>
            <div class="field"><label>Кафедра</label><input type="text" id="department"></div>
        </form>
        <div class="modal-actions">
            <button class="btn btn-muted" onclick="closeModal()">Бас тарту</button>
            <button class="btn btn-primary" onclick="saveUser()">Сақтау</button>
        </div>
    </div>
</div>

<script>
    let users = [];
    let currentRoleFilter = 'ALL';

    function applyTheme() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        document.getElementById('themeBtn').textContent = theme === 'dark' ? 'Light' : 'Dark';
    }

    function toggleTheme() {
        const current = localStorage.getItem('theme') || 'light';
        localStorage.setItem('theme', current === 'dark' ? 'light' : 'dark');
        applyTheme();
    }

    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            users = await response.json();
            applyFilters();
            updateStats();
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    function displayUsers(usersToDisplay) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        usersToDisplay.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${(user.id || '').substring(0, 8)}...</td>
                <td>${user.firstName || ''} ${user.lastName || ''}</td>
                <td>${user.email || '-'}</td>
                <td>${user.phone || '-'}</td>
                <td><span class="role-badge role-${(user.role || 'STUDENT').toLowerCase()}">${user.role || '-'}</span></td>
                <td>${user.group || user.department || '-'}</td>
                <td>${user.registrationDate ? new Date(user.registrationDate).toLocaleDateString('kk-KZ') : '-'}</td>
                <td class="actions">
                    <button class="action-btn edit-btn" onclick="editUser('${user.id}')">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteUser('${user.id}')">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function updateStats() {
        document.getElementById('totalUsers').textContent = users.length;
        document.getElementById('totalStudents').textContent = users.filter(u => u.role === 'STUDENT').length;
        document.getElementById('totalTeachers').textContent = users.filter(u => u.role === 'TEACHER').length;
        document.getElementById('totalAdmins').textContent = users.filter(u => u.role === 'ADMIN').length;
    }

    function setRoleFilter(role, btn) {
        currentRoleFilter = role;
        document.querySelectorAll('.filter-btn').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        applyFilters();
    }

    function searchUsers() {
        applyFilters();
    }

    function applyFilters() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        let filtered = users;

        if (currentRoleFilter !== 'ALL') {
            filtered = filtered.filter(user => user.role === currentRoleFilter);
        }

        filtered = filtered.filter(user => {
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
            const email = (user.email || '').toLowerCase();
            const group = (user.group || '').toLowerCase();
            const department = (user.department || '').toLowerCase();
            return fullName.includes(query) || email.includes(query) || group.includes(query) || department.includes(query);
        });

        displayUsers(filtered);
    }

    function openAddModal() {
        document.getElementById('modalTitle').textContent = 'Жаңа пайдаланушы қосу';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('userModal').classList.add('show');
    }

    function editUser(id) {
        const user = users.find(u => u.id === id);
        if (!user) return;

        document.getElementById('modalTitle').textContent = 'Пайдаланушыны өңдеу';
        document.getElementById('userId').value = user.id;
        document.getElementById('firstName').value = user.firstName || '';
        document.getElementById('lastName').value = user.lastName || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('phone').value = user.phone || '';
        document.getElementById('role').value = user.role || 'STUDENT';
        document.getElementById('group').value = user.group || '';
        document.getElementById('department').value = user.department || '';
        document.getElementById('userModal').classList.add('show');
    }

    async function saveUser() {
        const userId = document.getElementById('userId').value;
        const userData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            passwordHash: document.getElementById('password').value,
            role: document.getElementById('role').value,
            group: document.getElementById('group').value,
            department: document.getElementById('department').value
        };

        try {
            const url = userId ? `/api/users/${userId}` : '/api/users';
            const method = userId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
            const result = await response.json();

            if (result.success || result.message) {
                closeModal();
                loadUsers();
            } else {
                alert(result.error || 'Қате орын алды');
            }
        } catch (error) {
            alert('Серверге қосылу қатесі');
        }
    }

    async function deleteUser(id) {
        if (!confirm('Пайдаланушыны жоюға сенімдісіз бе?')) return;
        try {
            await fetch(`/api/users/${id}`, { method: 'DELETE' });
            loadUsers();
        } catch (error) {
            alert('Жою кезінде қате орын алды');
        }
    }

    function closeModal() {
        document.getElementById('userModal').classList.remove('show');
    }

    function exportUsers() {
        const csv = users.map(u => `${u.firstName},${u.lastName},${u.email},${u.role},${u.group || u.department || ''}`).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'users.csv';
        a.click();
    }

    function logout() {
        fetch('/api/auth/logout', { method: 'POST' }).then(() => window.location.href = '/login');
    }

    applyTheme();
    loadUsers();
</script>
<script src="/js/app-prefs.js"></script>
</body>
</html>
