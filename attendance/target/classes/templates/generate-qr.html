<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>QR Сессиялар</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        :root {
            --bg-1: #102447;
            --bg-2: #1f3f7a;
            --panel: rgba(255, 255, 255, 0.92);
            --text: #0f172a;
            --muted: #64748b;
            --line: #dbe4f0;
            --brand: #2257c7;
            --brand-2: #3b82f6;
            --accent: #0ea5a4;
            --danger: #dc2626;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Inter", "Manrope", "Segoe UI", sans-serif;
            background: radial-gradient(circle at 10% -20%, #4f46e5 0%, transparent 45%),
                        radial-gradient(circle at 90% 120%, #0ea5a4 0%, transparent 40%),
                        linear-gradient(135deg, var(--bg-1), var(--bg-2));
            color: var(--text);
        }
        .orb { position: fixed; border-radius: 999px; filter: blur(10px); opacity: .28; pointer-events: none; animation: float 9s ease-in-out infinite; }
        .orb.one { width: 320px; height: 320px; background: #38bdf8; top: 40px; right: 6%; }
        .orb.two { width: 280px; height: 280px; background: #22c55e; bottom: 0; left: -70px; animation-delay: 1.2s; }
        @keyframes float { 0% { transform: translateY(0) scale(1); } 50% { transform: translateY(-14px) scale(1.03); } 100% { transform: translateY(0) scale(1); } }

        .topbar { max-width: 1240px; margin: 0 auto; padding: 20px; display: flex; justify-content: space-between; align-items: center; color: #f8fafc; gap: 12px; }
        .title { font-size: 26px; font-weight: 800; }
        .top-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .link-btn { border: 1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.14); color: #fff; text-decoration: none; padding: 9px 14px; border-radius: 10px; font-weight: 600; }

        .page { max-width: 1240px; margin: 0 auto; padding: 0 20px 26px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .panel { background: var(--panel); border-radius: 18px; box-shadow: 0 14px 34px rgba(2, 6, 23, 0.2); border: 1px solid rgba(255,255,255,.35); padding: 18px; }
        .panel h2 { margin: 0 0 8px; font-size: 24px; }
        .panel p { margin: 0 0 12px; color: var(--muted); }

        .field { margin-bottom: 12px; }
        .field label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #334155; }
        .field input, .field select {
            width: 100%; border: 1px solid #cfd9e5; border-radius: 10px; padding: 10px 11px; font-size: 14px; outline: none;
        }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { border: none; border-radius: 10px; padding: 10px 14px; color: #fff; font-weight: 700; cursor: pointer; }
        .btn-primary { background: linear-gradient(90deg, var(--brand), var(--brand-2)); }
        .btn-danger { background: #fff1f2; color: var(--danger); border: 1px solid #fecaca; }

        .qr-box {
            min-height: 360px; border: 1px dashed #c7d6eb; border-radius: 14px; background: #f8fafc;
            display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 8px; padding: 18px;
        }
        .qr-text { font-family: "JetBrains Mono", monospace; font-size: 24px; letter-spacing: 2px; font-weight: 800; color: #1e3a8a; }
        #qrcode canvas { border-radius: 10px; background: #fff; padding: 8px; border: 1px solid #dbe4f0; }
        .timer { margin-top: 10px; font-weight: 700; color: #92400e; background: #ffedd5; border-radius: 10px; padding: 8px 12px; }

        .session-list { margin-top: 8px; display: grid; gap: 8px; }
        .session-item {
            border: 1px solid var(--line); background: #fff; border-radius: 12px; padding: 12px;
            display: flex; justify-content: space-between; gap: 10px; align-items: center;
        }
        .session-title { font-weight: 700; margin-bottom: 4px; }
        .session-meta { color: var(--muted); font-size: 13px; }
        .session-right { display: flex; align-items: center; gap: 8px; }
        .pill { background: #e0e7ff; color: #1e3a8a; border-radius: 999px; padding: 6px 10px; font-size: 12px; font-weight: 700; }

        .alert-item {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px;
            background: #f8fafc;
            font-size: 13px;
        }
        .alert-item.high { border-color: #fecaca; background: #fff1f2; }
        .alert-item.medium { border-color: #fde68a; background: #fffbeb; }

        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        @media (max-width: 560px) { .row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div class="orb one"></div>
<div class="orb two"></div>

<header class="topbar">
    <div class="title">QR Сессиялар</div>
    <div class="top-actions">
        <a href="/dashboard" class="link-btn">Басты бет</a>
        <a href="/attendance-report" class="link-btn">Қатысу есебі</a>
        <a href="/my-classes" class="link-btn">Сабақтар</a>
        <a href="/notifications" class="link-btn">Хабарландырулар</a>
        <button class="link-btn" onclick="enablePush()" style="cursor:pointer;">Push қосу</button>
    </div>
</header>

<main class="page">
    <div class="grid">
        <section class="panel">
            <h2>Жаңа QR жасау</h2>
            <p>Сабақты таңдап, QR сессияны бастаңыз.</p>
            <form id="generateForm">
                <div class="field">
                    <label for="classSelect">Сабақ</label>
                    <select id="classSelect" required>
                        <option value="">Таңдаңыз</option>
                        <option th:each="class : ${classes}"
                                th:value="${class.id}"
                                th:data-room="${class.room}"
                                th:data-day="${class.dayOfWeek}"
                                th:data-start="${class.startTime}"
                                th:data-end="${class.endTime}"
                                th:text="${class.name + ' - ' + class.group + ' (' + class.dayOfWeek + ' ' + class.startTime + ')'}">Сабақ</option>
                    </select>
                </div>
                <div class="field">
                    <label for="classSchedule">Кесте</label>
                    <input id="classSchedule" type="text" readonly placeholder="Сабақты таңдаңыз">
                </div>
                <div class="row">
                    <div class="field">
                        <label for="room">Аудитория</label>
                        <input id="room" type="text" readonly required>
                    </div>
                    <div class="field">
                        <label for="duration">Ұзақтығы</label>
                        <select id="durationUnit" onchange="onDurationUnitChange()" style="margin-bottom:6px;">
                            <option value="seconds">Секунд</option>
                            <option value="minutes">Минут</option>
                        </select>
                        <input id="duration" type="number" min="1" max="3600" value="15" required>
                    </div>
                </div>
                <button class="btn btn-primary" type="submit">QR жасау</button>
            </form>
        </section>

        <section class="panel">
            <h2>Белсенді QR</h2>
            <p>Студенттерге осы кодты көрсетіңіз.</p>
            <div class="qr-box" id="qrDisplay">
                <div style="color:#64748b;">Әлі QR сессия жоқ</div>
            </div>
        </section>
    </div>

    <section class="panel" style="margin-top:14px;">
        <h2 style="margin-bottom:8px;">Белсенді сессиялар тізімі</h2>
        <div id="activeSessions" class="session-list"></div>
    </section>

    <section class="panel" style="margin-top:14px;">
        <h2 style="margin-bottom:8px;">Кешігу/Қатыспау ескертулері</h2>
        <div id="alertsList" class="session-list">
            <div class="alert-item">Ескерту жоқ</div>
        </div>
    </section>
</main>

<script>
    let currentTimer = null;
    const shownAlertKeys = new Set();
    let durationSeconds = 15;
    let previousDurationUnit = 'seconds';

    document.getElementById('generateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const classId = document.getElementById('classSelect').value;
        const room = document.getElementById('room').value.trim();
        const unit = document.getElementById('durationUnit').value;
        const rawValue = Number(document.getElementById('duration').value) || 1;
        const duration = unit === 'minutes' ? rawValue * 60 : rawValue;
        durationSeconds = duration;
        renderDurationInput();

        try {
            const response = await fetch('/api/qr/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ classId, room, duration })
            });
            const data = await response.json();

            if (!data.success) {
                alert(data.error || 'QR код жасау кезінде қате');
                return;
            }

            renderCurrentQr(data);
            await loadActiveSessions();
        } catch (error) {
            alert('Сервер қатесі');
        }
    });

    function onDurationUnitChange() {
        const unit = document.getElementById('durationUnit').value;
        const input = document.getElementById('duration');
        const currentValue = Number(input.value) || 0;
        durationSeconds = previousDurationUnit === 'minutes' ? currentValue * 60 : currentValue;
        previousDurationUnit = unit;
        renderDurationInput();
    }

    function renderDurationInput() {
        const unit = document.getElementById('durationUnit').value;
        const input = document.getElementById('duration');
        if (unit === 'minutes') {
            input.max = '60';
            input.value = Math.max(1, Math.round(durationSeconds / 60));
        } else {
            input.max = '3600';
            input.value = Math.max(1, durationSeconds);
        }
        previousDurationUnit = unit;
    }

    function updateSelectedClassDetails() {
        const select = document.getElementById('classSelect');
        const selected = select.options[select.selectedIndex];
        const roomInput = document.getElementById('room');
        const scheduleInput = document.getElementById('classSchedule');

        if (!selected || !selected.value) {
            roomInput.value = '';
            scheduleInput.value = '';
            return;
        }

        const room = selected.getAttribute('data-room') || '-';
        const day = selected.getAttribute('data-day') || '';
        const start = selected.getAttribute('data-start') || '';
        const end = selected.getAttribute('data-end') || '';

        roomInput.value = room;
        scheduleInput.value = `${day} ${start}${end ? ' - ' + end : ''}`.trim();
    }

    function renderCurrentQr(data) {
        const display = document.getElementById('qrDisplay');
        const selectedClass = document.getElementById('classSelect').selectedOptions[0]?.text || '-';

        display.innerHTML = `
            <div id="qrcode"></div>
            <div class="qr-text">${data.qrCode}</div>
            <div style="font-size:13px;color:#475569;">${selectedClass}</div>
            <div class="timer" id="timerText">00:00</div>
        `;

        QRCode.toCanvas(document.createElement('canvas'), data.qrCode, { width: 220, margin: 1 }, (err, canvas) => {
            if (err) return;
            document.getElementById('qrcode').appendChild(canvas);
        });

        startTimer(new Date(data.expiresAt));
    }

    function startTimer(expiresAt) {
        if (currentTimer) clearInterval(currentTimer);
        currentTimer = setInterval(() => {
            const diff = expiresAt - new Date();
            const timerEl = document.getElementById('timerText');
            if (!timerEl) return;

            if (diff <= 0) {
                clearInterval(currentTimer);
                timerEl.textContent = 'Мерзімі аяқталды';
                loadActiveSessions();
                return;
            }

            const mm = Math.floor(diff / 60000).toString().padStart(2, '0');
            const ss = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
            timerEl.textContent = `${mm}:${ss}`;
        }, 1000);
    }

    async function loadActiveSessions() {
        try {
            const response = await fetch('/api/qr/sessions');
            const data = await response.json();
            const container = document.getElementById('activeSessions');

            if (!data.success || !data.sessions || !data.sessions.length) {
                container.innerHTML = '<div style="color:#64748b;">Белсенді сессиялар жоқ</div>';
                return;
            }

            container.innerHTML = data.sessions.map(session => `
                <div class="session-item">
                    <div>
                        <div class="session-title">${escapeHtml(session.className || '-')}</div>
                        <div class="session-meta">Аудитория: ${escapeHtml(session.room || '-')} | Код: ${escapeHtml(session.qrCode || '-')}</div>
                        <div class="session-meta">Оқытушы: ${escapeHtml(session.teacherName || '-')}</div>
                    </div>
                    <div class="session-right">
                        <span class="pill">${session.scannedCount || 0} студент</span>
                        <button class="btn btn-danger" onclick="endSession('${session.id}')">Аяқтау</button>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('sessions error', error);
        }
    }

    async function endSession(id) {
        if (!confirm('Сессияны аяқтайсыз ба?')) return;
        try {
            const response = await fetch(`/api/qr/sessions/${id}/end`, { method: 'POST' });
            const data = await response.json();
            if (!data.success) {
                alert(data.error || 'Сессияны аяқтау мүмкін болмады');
                return;
            }
            await loadActiveSessions();
        } catch (_) {
            alert('Сервер қатесі');
        }
    }

    function escapeHtml(value) {
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    loadActiveSessions();
    setInterval(loadActiveSessions, 10000);
    renderDurationInput();
    document.getElementById('classSelect').addEventListener('change', updateSelectedClassDetails);

    async function loadAttendanceAlerts() {
        try {
            const data = await fetch('/api/alerts/attendance').then(r => r.json());
            if (!data.success) return;
            renderAlerts(data.alerts || []);
            showBrowserNotifications(data.alerts || []);
        } catch (error) {
            console.error('alerts error', error);
        }
    }

    function renderAlerts(alerts) {
        const list = document.getElementById('alertsList');
        if (!alerts.length) {
            list.innerHTML = '<div class="alert-item">Ескерту жоқ</div>';
            return;
        }
        list.innerHTML = alerts.slice(0, 8).map(a => `
            <div class="alert-item ${a.severity === 'HIGH' ? 'high' : 'medium'}">
                <strong>${a.type === 'ABSENT' ? 'Қатыспады' : 'Өте кешікті'}:</strong>
                ${a.studentName} (${a.group}) - ${a.className}
            </div>
        `).join('');
    }

    function showBrowserNotifications(alerts) {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        alerts.forEach(a => {
            if (shownAlertKeys.has(a.key)) return;
            shownAlertKeys.add(a.key);
            new Notification(a.type === 'ABSENT' ? 'Сабаққа келмеді' : 'Өте кешігуде', {
                body: `${a.studentName} - ${a.className} (${a.group})`
            });
        });
    }

    async function enablePush() {
        if (!('Notification' in window)) {
            alert('Бұл браузерде push қолдау жоқ');
            return;
        }
        if (Notification.permission === 'granted') {
            alert('Push ескертулер белсенді');
            return;
        }
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            alert('Push ескертулер қосылды');
            loadAttendanceAlerts();
        } else {
            alert('Push рұқсаты берілмеді');
        }
    }

    loadAttendanceAlerts();
    setInterval(loadAttendanceAlerts, 30000);
</script>
<script src="/js/app-prefs.js"></script>
</body>
</html>
