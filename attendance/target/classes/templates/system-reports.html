<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–ñ“Ø–π–µ –µ—Å–µ–ø—Ç–µ—Ä—ñ - Attendance System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #1F2937;
            --gray: #6B7280;
            --light: #F9FAFB;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .navbar h1 {
            color: white;
            font-size: 24px;
        }
        
        .nav-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            position: relative;
        }
        
        .profile-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            min-width: 200px;
            z-index: 1000;
        }
        
        .profile-menu.show {
            display: block;
        }
        
        .profile-menu a {
            display: block;
            padding: 10px;
            color: var(--dark);
            text-decoration: none;
            border-radius: 5px;
        }
        
        .profile-menu a:hover {
            background: var(--light);
        }
        
        .nav-btn {
            padding: 8px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .page-header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-content h2 {
            color: var(--dark);
            font-size: 32px;
        }
        
        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-filter input {
            padding: 8px 15px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .stat-icon.blue {
            background: #DBEAFE;
            color: #2563EB;
        }
        
        .stat-icon.green {
            background: #D1FAE5;
            color: #059669;
        }
        
        .stat-icon.yellow {
            background: #FEF3C7;
            color: #D97706;
        }
        
        .stat-icon.red {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }
        
        .stat-change {
            margin-top: 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-change.positive {
            color: var(--success);
        }
        
        .stat-change.negative {
            color: var(--danger);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .chart-card h3 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .report-table {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .report-table h3 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: var(--light);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid #E5E7EB;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        tr:hover {
            background: #F9FAFB;
        }
        
        .attendance-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .attendance-high {
            background: #D1FAE5;
            color: #059669;
        }
        
        .attendance-medium {
            background: #FEF3C7;
            color: #D97706;
        }
        
        .attendance-low {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .export-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üìä –ñ“Ø–π–µ –µ—Å–µ–ø—Ç–µ—Ä—ñ</h1>
        <div class="nav-right">
            <a href="/dashboard" class="nav-btn">üìä Dashboard</a>
            <div class="profile-icon" onclick="toggleProfile()" th:text="${#strings.substring(fullName, 0, 1)}">A</div>
            <div class="profile-menu" id="profileMenu">
                <a href="/profile">üë§ –ú–µ–Ω—ñ“£ –ø—Ä–æ—Ñ–∏–ª—ñ–º</a>
                <a href="/settings">‚öôÔ∏è –ë–∞–ø—Ç–∞—É–ª–∞—Ä</a>
                <a href="#" onclick="logout()">üö™ –®—ã“ì—É</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <div class="header-content">
                <h2>–ñ“Ø–π–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞—Å—ã –∂”ô–Ω–µ –µ—Å–µ–ø—Ç–µ—Ä</h2>
                <div class="date-filter">
                    <input type="date" id="startDate">
                    <span>-</span>
                    <input type="date" id="endDate">
                    <button class="btn btn-primary" onclick="filterReports()">–°“Ø–∑—É</button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">üìö</div>
                <div class="stat-number" id="totalClasses">0</div>
                <div class="stat-label">–ë–∞—Ä–ª—ã“õ —Å–∞–±–∞“õ—Ç–∞—Ä</div>
                <div class="stat-change positive">‚Üë 12% ”©—Ç–∫–µ–Ω –∞–π–¥–∞–Ω</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">‚úÖ</div>
                <div class="stat-number" id="totalAttendance">0</div>
                <div class="stat-label">–ñ–∞–ª–ø—ã “õ–∞—Ç—ã—Å—É</div>
                <div class="stat-change positive">‚Üë 8% ”©—Ç–∫–µ–Ω –∞–ø—Ç–∞–¥–∞–Ω</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon yellow">üë•</div>
                <div class="stat-number" id="activeStudents">0</div>
                <div class="stat-label">–ë–µ–ª—Å–µ–Ω–¥—ñ —Å—Ç—É–¥–µ–Ω—Ç—Ç–µ—Ä</div>
                <div class="stat-change negative">‚Üì 3% –∫–µ—à–µ</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">üìà</div>
                <div class="stat-number" id="avgAttendance">0%</div>
                <div class="stat-label">–û—Ä—Ç–∞—à–∞ “õ–∞—Ç—ã—Å—É</div>
                <div class="stat-change positive">‚Üë 5% ”©—Ç–∫–µ–Ω —Å–µ–º–µ—Å—Ç—Ä–¥–µ–Ω</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>üìä –ê–ø—Ç–∞–ª—ã“õ “õ–∞—Ç—ã—Å—É —Ç—Ä–µ–Ω–¥—Ç–µ—Ä—ñ</h3>
                <canvas id="attendanceChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>üìà –¢–æ–ø—Ç–∞—Ä –±–æ–π—ã–Ω—à–∞ “õ–∞—Ç—ã—Å—É</h3>
                <canvas id="groupChart"></canvas>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>üïê –°–∞–±–∞“õ —É–∞“õ—ã—Ç—Ç–∞—Ä—ã –±–æ–π—ã–Ω—à–∞ “õ–∞—Ç—ã—Å—É</h3>
                <canvas id="timeChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>üì± QR —Å–∫–∞–Ω–µ—Ä–ª–µ—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞—Å—ã</h3>
                <canvas id="qrChart"></canvas>
            </div>
        </div>

        <!-- Top Students Table -->
        <div class="report-table">
            <h3>üèÜ “Æ–∑–¥—ñ–∫ —Å—Ç—É–¥–µ–Ω—Ç—Ç–µ—Ä (“õ–∞—Ç—ã—Å—É –±–æ–π—ã–Ω—à–∞)</h3>
            <table>
                <thead>
                    <tr>
                        <th>–†–µ–π—Ç–∏–Ω–≥</th>
                        <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                        <th>–¢–æ–ø</th>
                        <th>“ö–∞—Ç—ã—Å—É %</th>
                        <th>–°–∞–±–∞“õ—Ç–∞—Ä</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody id="topStudentsTable">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Classes Report Table -->
        <div class="report-table" style="margin-top: 30px;">
            <h3>üìö –°–∞–±–∞“õ—Ç–∞—Ä –±–æ–π—ã–Ω—à–∞ –µ—Å–µ–ø</h3>
            <table>
                <thead>
                    <tr>
                        <th>–°–∞–±–∞“õ</th>
                        <th>–û“õ—ã—Ç—É—à—ã</th>
                        <th>–¢–æ–ø</th>
                        <th>–°—Ç—É–¥–µ–Ω—Ç—Ç–µ—Ä</th>
                        <th>–û—Ä—Ç. “õ–∞—Ç—ã—Å—É</th>
                        <th>–°–æ“£“ì—ã —Å–∞–±–∞“õ</th>
                    </tr>
                </thead>
                <tbody id="classesReportTable">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="export-section">
            <h3>üì• –ï—Å–µ–ø—Ç–µ—Ä–¥—ñ —ç–∫—Å–ø–æ—Ä—Ç—Ç–∞—É</h3>
            <div class="export-buttons">
                <button class="btn btn-primary" onclick="exportPDF()">üìÑ PDF –∂“Ø–∫—Ç–µ—É</button>
                <button class="btn btn-primary" onclick="exportExcel()">üìä Excel –∂“Ø–∫—Ç–µ—É</button>
                <button class="btn btn-primary" onclick="exportCSV()">üìÅ CSV –∂“Ø–∫—Ç–µ—É</button>
                <button class="btn btn-primary" onclick="printReport()">üñ®Ô∏è –ë–∞—Å—ã–ø —à—ã“ì–∞—Ä—É</button>
            </div>
        </div>
    </div>

    <script>
        const ctx1 = document.getElementById('attendanceChart').getContext('2d');
        const attendanceChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: ['–î“Ø–π—Å–µ–Ω–±—ñ', '–°–µ–π—Å–µ–Ω–±—ñ', '–°”ô—Ä—Å–µ–Ω–±—ñ', '–ë–µ–π—Å–µ–Ω–±—ñ', '–ñ“±–º–∞'],
                datasets: [{
                    label: '“ö–∞—Ç—ã—Å—É %',
                    data: [85, 88, 82, 90, 87],
                    borderColor: '#6366F1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

        const ctx2 = document.getElementById('groupChart').getContext('2d');
        const groupChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['–ò–°-2101', '–ò–°-2102', '–ò–°-2103', '–ò–°-2104'],
                datasets: [{
                    label: '“ö–∞—Ç—ã—Å—É %',
                    data: [92, 85, 88, 79],
                    backgroundColor: ['#10B981', '#F59E0B', '#6366F1', '#EF4444']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        const ctx3 = document.getElementById('timeChart').getContext('2d');
        const timeChart = new Chart(ctx3, {
            type: 'doughnut',
            data: {
                labels: ['9:00-10:30', '11:00-12:30', '14:00-15:30', '16:00-17:30'],
                datasets: [{
                    data: [95, 88, 75, 82],
                    backgroundColor: ['#10B981', '#6366F1', '#F59E0B', '#EF4444']
                }]
            },
            options: {
                responsive: true
            }
        });

        const ctx4 = document.getElementById('qrChart').getContext('2d');
        const qrChart = new Chart(ctx4, {
            type: 'bar',
            data: {
                labels: ['–°”ô—Ç—Ç—ñ', '–ö–µ—à—ñ–≥—ñ–ø', '–ú–µ—Ä–∑—ñ–º—ñ ”©—Ç–∫–µ–Ω', '“ö–∞—Ç–µ'],
                datasets: [{
                    label: 'QR —Å–∫–∞–Ω–µ—Ä–ª–µ—É',
                    data: [450, 62, 28, 15],
                    backgroundColor: ['#10B981', '#F59E0B', '#6B7280', '#EF4444']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        async function loadReports() {
            try {
                const [classes, attendance, users] = await Promise.all([
                    fetch('/api/classes').then(r => r.json()),
                    fetch('/api/attendance/today').then(r => r.json()),
                    fetch('/api/auth/users').then(r => r.json())
                ]);

                document.getElementById('totalClasses').textContent = classes.length;
                document.getElementById('totalAttendance').textContent = attendance.length;
                document.getElementById('activeStudents').textContent = 
                    users.filter(u => u.role === 'STUDENT').length;
                
                const avgRate = attendance.length > 0 
                    ? Math.round(attendance.filter(a => a.present).length / attendance.length * 100)
                    : 0;
                document.getElementById('avgAttendance').textContent = avgRate + '%';

                loadTopStudents();
                
                loadClassesReport();
                
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        async function loadTopStudents() {
            try {
                const users = await fetch('/api/auth/users').then(r => r.json());
                const students = users.filter(u => u.role === 'STUDENT');
                
                const tbody = document.getElementById('topStudentsTable');
                tbody.innerHTML = '';
                
                const topStudents = [
                    { name: '–ê–π–¥–∞–Ω–∞ “ö–∞—Å—ã–º–æ–≤–∞', group: '–ò–°-2101', attendance: 98, classes: 45 },
                    { name: '–ï—Ä–ª–∞–Ω –°”ô—Ä—Å–µ–Ω–±–∞–µ–≤', group: '–ò–°-2102', attendance: 95, classes: 43 },
                    { name: '–ì“Ø–ª–Ω”ô—Ä –ê—Ö–º–µ—Ç–æ–≤–∞', group: '–ò–°-2101', attendance: 93, classes: 42 },
                    { name: '–ù“±—Ä–ª–∞–Ω –ñ“±–º–∞–±–µ–∫–æ–≤', group: '–ò–°-2103', attendance: 91, classes: 41 },
                    { name: '–ê–π–≥–µ—Ä—ñ–º –ú“±—Ä–∞—Ç–æ–≤–∞', group: '–ò–°-2102', attendance: 89, classes: 40 }
                ];
                
                topStudents.forEach((student, index) => {
                    const row = document.createElement('tr');
                    const badgeClass = student.attendance >= 95 ? 'attendance-high' : 
                                      student.attendance >= 80 ? 'attendance-medium' : 'attendance-low';
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${student.name}</td>
                        <td>${student.group}</td>
                        <td>${student.attendance}%</td>
                        <td>${student.classes}</td>
                        <td><span class="attendance-badge ${badgeClass}">
                            ${student.attendance >= 95 ? '“Æ–∑–¥—ñ–∫' : 
                              student.attendance >= 80 ? '–ñ–∞“õ—Å—ã' : '–¢”©–º–µ–Ω'}
                        </span></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading top students:', error);
            }
        }

        async function loadClassesReport() {
            try {
                const classes = await fetch('/api/classes').then(r => r.json());
                const tbody = document.getElementById('classesReportTable');
                tbody.innerHTML = '';
                
                classes.slice(0, 5).forEach(cls => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cls.name}</td>
                        <td>${cls.teacherName || '–¢–∞“ì–∞–π—ã–Ω–¥–∞–ª–º–∞“ì–∞–Ω'}</td>
                        <td>${cls.group}</td>
                        <td>${Math.floor(Math.random() * 20) + 15}</td>
                        <td>${Math.floor(Math.random() * 15) + 80}%</td>
                        <td>${new Date().toLocaleDateString('kk-KZ')}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading classes report:', error);
            }
        }

        function filterReports() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                alert(`–ï—Å–µ–ø—Ç–µ—Ä ${startDate} - ${endDate} –∞—Ä–∞–ª—ã“ì—ã “Ø—à—ñ–Ω –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã`);
                loadReports();
            }
        }

        function exportPDF() {
            alert('PDF –µ—Å–µ–±—ñ –¥–∞–π—ã–Ω–¥–∞–ª—É–¥–∞...');
        }

        function exportExcel() {
            alert('Excel –µ—Å–µ–±—ñ –¥–∞–π—ã–Ω–¥–∞–ª—É–¥–∞...');
        }

        function exportCSV() {
            const data = '–°—Ç—É–¥–µ–Ω—Ç,–¢–æ–ø,“ö–∞—Ç—ã—Å—É\n–ê–π–¥–∞–Ω–∞,–ò–°-2101,98%\n–ï—Ä–ª–∞–Ω,–ò–°-2102,95%';
            const blob = new Blob([data], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'attendance-report.csv';
            a.click();
        }

        function printReport() {
            window.print();
        }

        function toggleProfile() {
            document.getElementById('profileMenu').classList.toggle('show');
        }

        function logout() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(() => window.location.href = '/login');
        }

        document.getElementById('startDate').valueAsDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        document.getElementById('endDate').valueAsDate = new Date();

        loadReports();
    </script>
</body>
</html>
