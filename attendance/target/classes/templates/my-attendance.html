<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Менің қатысуым</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2e5ccd;
            --accent: #5eb680;
            --danger: #d64545;
            --warning: #de9d1d;
            --text: #1e293b;
            --muted: #64748b;
            --bg: #f1f5f9;
            --card: #ffffff;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(115deg, #1e3a8a 0%, #172554 100%);
            min-height: 100vh;
            color: var(--text);
        }
        .topbar {
            max-width: 1280px;
            margin: 0 auto;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
        }
        .topbar h1 { margin: 0; font-size: 24px; }
        .topbar a {
            color: #e2e8f0;
            text-decoration: none;
            margin-left: 16px;
            font-size: 14px;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 20px 28px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .card {
            background: var(--card);
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.14);
        }
        .metric-title { color: var(--muted); font-size: 13px; }
        .metric-value { font-size: 32px; font-weight: 700; margin-top: 8px; }
        .metric-good { color: var(--accent); }
        .metric-warn { color: var(--warning); }
        .metric-bad { color: var(--danger); }
        .charts {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        .chart-box {
            position: relative;
            height: 260px;
            min-height: 260px;
            max-height: 260px;
            width: 100%;
            overflow: hidden;
        }
        .chart-box canvas {
            width: 100% !important;
            height: 260px !important;
        }
        .section-title {
            margin: 0 0 14px;
            font-size: 18px;
        }
        .table-wrap { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
            font-size: 14px;
        }
        th { color: var(--muted); font-weight: 600; }
        .badge {
            display: inline-block;
            min-width: 82px;
            text-align: center;
            padding: 5px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge.present { background: #d1fae5; color: #065f46; }
        .badge.late { background: #fef3c7; color: #92400e; }
        .badge.absent { background: #fee2e2; color: #991b1b; }
        @media (max-width: 980px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
            .charts { grid-template-columns: 1fr; }
        }
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="topbar">
    <h1>Қатысу статистикасы</h1>
    <div>
        <a href="/dashboard">Басты бет</a>
        <a href="/schedule">Кесте</a>
        <a href="/profile">Профиль</a>
    </div>
</div>

<div class="container">
    <div class="grid">
        <div class="card">
            <div class="metric-title">Жалпы қатысу пайызы</div>
            <div class="metric-value metric-good" th:text="${attendanceRate + '%'}">0%</div>
        </div>
        <div class="card">
            <div class="metric-title">Барлық сабақтар</div>
            <div class="metric-value" th:text="${totalClasses}">0</div>
        </div>
        <div class="card">
            <div class="metric-title">Кешіккендер</div>
            <div class="metric-value metric-warn" th:text="${lateCount}">0</div>
        </div>
        <div class="card">
            <div class="metric-title">Қатыспағандар</div>
            <div class="metric-value metric-bad" th:text="${absentCount}">0</div>
        </div>
    </div>

    <div class="charts">
        <div class="card">
            <h2 class="section-title">14 күндік динамика</h2>
            <div class="chart-box">
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2 class="section-title">Пәндер бойынша</h2>
            <div class="chart-box">
                <canvas id="subjectsChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="section-title">Соңғы жазбалар</h2>
        <div class="table-wrap">
            <table>
                <thead>
                <tr>
                    <th>Күні</th>
                    <th>Пән</th>
                    <th>Оқытушы</th>
                    <th>Белгіленген уақыт</th>
                    <th>Статус</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${attendances == null || attendances.isEmpty()}">
                    <td colspan="5">Қатысу жазбалары табылмады</td>
                </tr>
                <tr th:each="a : ${attendances}">
                    <td th:text="${a.date}">2026-01-01</td>
                    <td th:text="${a.className}">Class</td>
                    <td th:text="${a.teacherName}">Teacher</td>
                    <td th:text="${a.checkInTime != null ? #temporals.format(a.checkInTime, 'HH:mm') : '-'}">09:00</td>
                    <td>
                        <span class="badge present" th:if="${a.status == 'PRESENT'}">Қатысты</span>
                        <span class="badge late" th:if="${a.status == 'LATE'}">Кешікті</span>
                        <span class="badge absent" th:if="${a.status == 'ABSENT'}">Қатыспады</span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const trendLabels = /*[[${attendanceTrendLabels}]]*/ [];
    const trendValues = /*[[${attendanceTrendValues}]]*/ [];
    const subjectLabels = /*[[${subjectLabels}]]*/ [];
    const subjectValues = /*[[${subjectValues}]]*/ [];

    function toStableTrend(values) {
        const normalized = [];
        let lastValue = 0;
        let hasRealValue = false;

        for (const v of values) {
            if (v === null || v === undefined || Number.isNaN(v)) {
                normalized.push(lastValue);
                continue;
            }
            const safe = Math.min(100, Math.max(0, Number(v)));
            lastValue = safe;
            hasRealValue = true;
            normalized.push(safe);
        }

        if (!hasRealValue) {
            return values.map(() => 0);
        }
        return normalized;
    }

    const stableTrendValues = toStableTrend(trendValues);
    const hasTrendData = stableTrendValues.some(v => v > 0);
    const finalTrendLabels = hasTrendData ? trendLabels : ['0', '0'];
    const finalTrendValues = hasTrendData ? stableTrendValues : [0, 0];
    const safeSubjectValues = subjectValues.map(v => {
        if (v === null || v === undefined || Number.isNaN(v)) return 0;
        return Math.min(100, Math.max(0, Number(v)));
    });

    const trendCtx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: finalTrendLabels,
            datasets: [{
                label: 'Қатысу %',
                data: finalTrendValues,
                borderColor: '#2e5ccd',
                backgroundColor: 'rgba(46, 92, 205, 0.12)',
                borderWidth: 2,
                pointRadius: hasTrendData ? 4 : 0,
                spanGaps: false,
                tension: 0,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 450,
                easing: 'linear'
            },
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    grace: 0,
                    ticks: { callback: (v) => v + '%' }
                }
            }
        }
    });

    if (!hasTrendData) {
        const box = document.querySelectorAll('.charts .card .chart-box')[0];
        if (box) {
            box.insertAdjacentHTML('beforeend', '<div style=\"position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#64748b;font-size:13px;\">Әзірге график үшін жеткілікті дерек жоқ</div>');
        }
    }

    const subjectCtx = document.getElementById('subjectsChart').getContext('2d');
    new Chart(subjectCtx, {
        type: 'bar',
        data: {
            labels: subjectLabels,
            datasets: [{
                data: safeSubjectValues,
                backgroundColor: ['#2e5ccd', '#5eb680', '#de9d1d', '#0ea5e9', '#a855f7', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 450,
                easing: 'linear'
            },
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    ticks: { callback: (v) => v + '%' }
                }
            }
        }
    });
</script>
<script src="/js/app-prefs.js"></script>
</body>
</html>
